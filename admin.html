<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', Tahoma; }
        .student-block { transition: all 0.3s; border-right: 5px solid #4e73df; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card p-4 text-center" style="width: 350px;">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <input type="password" id="adminPass" class="form-control my-3 text-center" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²">
        <button onclick="checkAdminPass()" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="adminContent" style="display:none;" class="container py-5">
    <h2 class="mb-4">Ø¥Ø¯Ø§Ø±Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>

    <div class="row g-3 bg-white p-3 rounded shadow-sm mb-4">
        <div class="col-md-3">
            <label>Ø§Ù„Ù‚Ø³Ù…:</label>
            <select id="dept" class="form-select" onchange="loadData()">
                <option value="Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ">Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ</option>
                <option value="Ø­Ø§Ø³ÙˆØ¨">Ø­Ø§Ø³ÙˆØ¨</option>
                <option value="Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ">Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ</option>
                <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">Ù†ÙØ·</option>
                <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">Ø³ÙŠØ§Ø±Ø§Øª</option>
            </select>
        </div>
        <div class="col-md-3">
            <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</label>
            <select id="stage" class="form-select" onchange="loadData()">
                <option value="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                <option value="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                <option value="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
            </select>
        </div>
        <div class="col-md-6 d-flex align-items-end gap-2">
            <button class="btn btn-primary" onclick="addNewStudent()">+ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
            <button class="btn btn-success" onclick="saveAll()">ğŸ’¾ Ø­ÙØ¸ ÙˆÙ†Ø´Ø±</button>
            <button class="btn btn-outline-secondary" onclick="exportCodes()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
        </div>
    </div>

    <div class="card p-3 mb-4 shadow-sm border-0 bg-light">
    <label class="form-label fw-bold">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø¬Ø¯Ø§ÙˆÙ„ Ø¬ÙˆØ¬Ù„ (Google Sheets)</label>
    <div class="input-group">
        <input type="text" id="sheet_url" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙˆÙ„ Ø¬ÙˆØ¬Ù„ Ù‡Ù†Ø§...">
        <button class="btn btn-success" onclick="importFromGoogleSheets()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
    <small class="text-muted mt-1">ØªØ£ÙƒØ¯ Ù…Ù† "Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨" Ø¨ØµÙŠØºØ© CSV Ø£ÙˆÙ„Ø§Ù‹.</small>
</div>
    <div id="studentsContainer"></div>
</div>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = { databaseURL: "https://school-project-f09f4-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
    const subjectsDatabase = {
        "Ø£Ù…Ù† Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ": {
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø­Ø§Ø³ÙˆØ¨", "Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª", "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©","Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø§Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ", "Ø­Ù…Ø§ÙŠØ© Ø§Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„", "Ø§Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ§Øª"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©", "Ø£Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ§Øª", "Ø­Ù…Ø§ÙŠØ© Ø§Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„", "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ø§Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ"]
        },
        "Ø­Ø§Ø³ÙˆØ¨": {
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©","Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø­Ø§Ø³ÙˆØ¨", "Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª", "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©","Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "ØµÙŠØ§Ù†Ø© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨",  "Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØµÙŠØ§Ù†Ø© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©", "Ù…Ø®ØªØ¨Ø± ÙˆØ´Ø¨ÙƒØ§Øª Ø§Ù„Ø§Ù†ØªØ±Ù†Øª"]
        },
        "Ù…ÙŠÙƒØ§Ù†ÙŠÙƒ": {
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©","Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"]
        },
        "ÙƒÙ‡Ø±Ø¨Ø§Ø¡": {
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©","Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"]
        },
        "Ù†ÙØ·": {
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©","Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ ÙˆØ§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"]
        },
        "Ø³ÙŠØ§Ø±Ø§Øª": {
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"],
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©": ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø·Ø¨ÙŠØ¹ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠ", "Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ"]
        }
    };

    // 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    function checkAdminPass() {
        if(document.getElementById('adminPass').value === "198196") {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadData();
        } else { alert("Ø±Ù…Ø² Ø®Ø·Ø£!"); }
    }
async function importFromGoogleSheets() {
    const url = document.getElementById('sheet_url').value;
    if (!url) { alert("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø´Ø± (CSV) Ø£ÙˆÙ„Ø§Ù‹"); return; }

    try {
        const response = await fetch(url);
        const text = await response.text();
        const rows = text.split('\n').map(r => r.split(','));
        const headers = rows[0].map(h => h.trim());

        const jsonRows = rows.slice(1).map(row => {
            let obj = {};
            row.forEach((cell, i) => { if(headers[i]) obj[headers[i]] = cell.trim(); });
            return obj;
        });

        const studentsMap = {};
        jsonRows.forEach(row => {
            const name = row["Ø§Ù„Ø§Ø³Ù…"];
            if (!name) return;

            if (!studentsMap[name]) {
                studentsMap[name] = { name: name, code: row["Ø§Ù„ÙƒÙˆØ¯"] || Math.floor(1000 + Math.random()*9000), subjects: [] };
            }
            studentsMap[name].subjects.push({
                subject: row["Ø§Ù„Ù…Ø§Ø¯Ø©"], f1: row["Ù1"], mid: row["Ù†ØµÙ Ø§Ù„Ø³Ù†Ø©"], f2: row["Ù2"], finalEx: row["Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"]
            });
        });

        Object.values(studentsMap).forEach(st => addNewStudent(st));
        alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹ÙŠ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (e) {
        alert("Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ùˆ Ø±Ø§Ø¨Ø· 'Ù†Ø´Ø± ÙƒÙ€ CSV' ÙˆØ£Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ØªØ§Ø­ Ù„Ù„Ø¬Ù…ÙŠØ¹.");
    }
}
    function generateRandomCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }

    function addNewStudent(data = null) {
    const container = document.getElementById('studentsContainer');
    const dept = document.getElementById('dept').value;
    const stage = document.getElementById('stage').value;

    // Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø·Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
    if (!dept || !stage) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }

    const card = document.createElement('div');
    card.className = "student-block mb-4 p-4 bg-white shadow-sm rounded";
    
    card.innerHTML = `
        <div class="row g-2 mb-3">
            <div class="col-md-6"><input type="text" class="form-control st-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" value="${data ? data.name : ''}"></div>
            <div class="col-md-4"><input type="text" class="form-control st-code" placeholder="Ø§Ù„ÙƒÙˆØ¯" value="${data ? data.code : ''}"></div>
            <div class="col-md-2"><button class="btn btn-danger btn-sm w-100" onclick="this.closest('.student-block').remove()">Ø­Ø°Ù</button></div>
        </div>
        <table class="table table-sm text-center">
            <thead><tr class="small"><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ù1</th><th>Ù†ØµÙ</th><th>Ù2</th><th>Ø§Ù„Ø³Ø¹ÙŠ</th><th>Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
            <tbody class="subjects-list"></tbody>
        </table>`;
    
    container.prepend(card);
    const tbody = card.querySelector('.subjects-list');
    const subjects = (data && data.subjects) ? data.subjects : subjectsDatabase[dept][stage].map(s => ({subject: s}));
    
    subjects.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm sub-name" value="${s.subject}" readonly></td>
            <td><input type="number" class="form-control form-control-sm f1" value="${s.f1||''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm mid" value="${s.mid||''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm f2" value="${s.f2||''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm saei bg-light" value="${s.saei||''}" readonly></td>
            <td><input type="number" class="form-control form-control-sm final" value="${s.finalEx||''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm total bg-light fw-bold" value="${s.total||''}" readonly></td>`;
        tbody.appendChild(tr);
    });
}
    function addNewStudent(data = null) {
    const container = document.getElementById('studentsContainer');
    const dept = document.getElementById('dept').value;
    const stage = document.getElementById('stage').value;

    if (!dept || !stage) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠØ©");
        return;
    }

    const card = document.createElement('div');
    card.className = "student-block mb-4 p-4 bg-white shadow-sm rounded border-start border-4 border-primary";
    
    card.innerHTML = `
        <div class="row g-2 mb-3">
            <div class="col-md-6"><input type="text" class="form-control st-name fw-bold" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" value="${data ? data.name : ''}"></div>
            <div class="col-md-4"><input type="text" class="form-control st-code text-muted" placeholder="Ø§Ù„ÙƒÙˆØ¯" value="${data ? data.code : ''}"></div>
            <div class="col-md-2"><button class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('.student-block').remove()">Ø­Ø°Ù</button></div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm text-center align-middle">
                <thead><tr class="table-light small"><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ù1</th><th>Ù†ØµÙ</th><th>Ù2</th><th>Ø§Ù„Ø³Ø¹ÙŠ</th><th>Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
                <tbody class="subjects-list"></tbody>
            </table>
        </div>`;
    
    container.prepend(card);
    const tbody = card.querySelector('.subjects-list');
    
    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø©
    const defaultSubjects = subjectsDatabase[dept][stage];
    
    defaultSubjects.forEach(subName => {
        // Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
        const s = data && data.subjects ? data.subjects.find(item => item.subject === subName) : null;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm sub-name" value="${subName}" readonly></td>
            <td><input type="number" class="form-control form-control-sm f1" value="${s ? s.f1 : ''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm mid" value="${s ? s.mid : ''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm f2" value="${s ? s.f2 : ''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm saei bg-light fw-bold" value="${s ? s.saei : ''}" readonly></td>
            <td><input type="number" class="form-control form-control-sm final" value="${s ? s.finalEx : ''}" oninput="calculateFullGrades(this)"></td>
            <td><input type="number" class="form-control form-control-sm total bg-success bg-opacity-10 fw-bold" value="${s ? s.total : ''}" readonly></td>`;
        tbody.appendChild(tr);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªÙˆØ±Ø¯Ø©
        if (s) { calculateFullGrades(tr.querySelector('.f1')); }
    });

        alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.");
    };
    reader.readAsArrayBuffer(file);


    function saveAll() {
        const dept = document.getElementById('dept').value;
        const stage = document.getElementById('stage').value;
        const students = [];
        document.querySelectorAll('.student-block').forEach(block => {
            const subs = [];
            block.querySelectorAll('.subjects-list tr').forEach(tr => {
                subs.push({
                    subject: tr.querySelector('.sub-name').value,
                    f1: tr.querySelector('.f1').value,
                    mid: tr.querySelector('.mid').value,
                    f2: tr.querySelector('.f2').value,
                    saei: tr.querySelector('.saei').value,
                    finalEx: tr.querySelector('.final').value,
                    total: tr.querySelector('.total').value
                });
            });
            students.push({ name: block.querySelector('.st-name').value, code: block.querySelector('.st-code').value, subjects: subs });
        });
        database.ref(`results/${dept}/${stage}`).set(students).then(() => alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!"));
    }

    function loadData() {
        const dept = document.getElementById('dept').value;
        const stage = document.getElementById('stage').value;
        document.getElementById('studentsContainer').innerHTML = "";
        database.ref(`results/${dept}/${stage}`).once('value').then(snap => {
            if(snap.val()) snap.val().forEach(s => addNewStudent(s));
        });
    }
    
    function exportCodes() {
        let rows = [];
        document.querySelectorAll('.student-block').forEach(b => {
            rows.push({ "Ø§Ù„Ø§Ø³Ù…": b.querySelector('.st-name').value, "Ø§Ù„ÙƒÙˆØ¯": b.querySelector('.st-code').value });
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø£ÙƒÙˆØ§Ø¯");
        XLSX.writeFile(wb, "Ø£ÙƒÙˆØ§Ø¯_Ø§Ù„Ø·Ù„Ø§Ø¨.xlsx");
    }
    function calculateFullGrades(inputElement) {
    const row = inputElement.closest('tr');
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ…
    const f1 = parseFloat(row.querySelector('.f1').value) || 0;
    const mid = parseFloat(row.querySelector('.mid').value) || 0;
    const f2 = parseFloat(row.querySelector('.f2').value) || 0;
    const finalEx = parseFloat(row.querySelector('.final').value) || 0;

    // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹ÙŠ: (Ù1 + Ù†ØµÙ Ø§Ù„Ø³Ù†Ø© + Ù2) / 3
    let saeiResult = (f1 + mid + f2) / 3;
    row.querySelector('.saei').value = Math.round(saeiResult);

    // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: (Ø§Ù„Ø³Ø¹ÙŠ + Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ) / 2
    const currentSaei = parseFloat(row.querySelector('.saei').value) || 0;
    let finalTotal = (currentSaei + finalEx) / 2;
    row.querySelector('.total').value = Math.round(finalTotal);
}
</script>
</body>
</html>